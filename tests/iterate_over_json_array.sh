#/usr/bin/env bash

#Ref: https://starkandwayne.com/blog/bash-for-loop-over-json-array-using-jq/

# set -x

# sample='[{"message":"foo"},{"message":"bar"}]'
sample='[{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Waiting for agent ping\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Waiting for DOWNLOAD_SOURCE\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Phase is DOWNLOAD_SOURCE\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 CODEBUILD_SRC_DIR=/codebuild/output/src927740863/src\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 YAML location is /codebuild/output/src927740863/src/tests/buildspec.yml\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Processing environment variables\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Moving to directory /codebuild/output/src927740863/src\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Registering with agent\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Phases found in YAML: 1\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 BUILD: 1 commands\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Phase complete: DOWNLOAD_SOURCE Success: true\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Phase context status code: Message: \n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Entering phase INSTALL\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Phase complete: INSTALL Success: true\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Phase context status code: Message: \n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Entering phase PRE_BUILD\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Phase complete: PRE_BUILD Success: true\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:42 Phase context status code: Message: \n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:43 Entering phase BUILD\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":"[Container] 2018/10/06 21:47:43 Running command timeout 15 sh -c \"until false; do echo .; sleep 1; done\"\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":".\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":".\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":".\n"},{"ingestionTime":1538862466367,"timestamp":1538862466346,"message":".\n"},{"ingestionTime":1538862468386,"timestamp":1538862468379,"message":".\n"},{"ingestionTime":1538862468386,"timestamp":1538862468379,"message":".\n"}]'

for row in $(echo "${sample}" | jq -r '.[] | @base64'); do
    _jq() {
     echo ${row} | base64 --decode | jq -r ${1}
    }

   echo $(_jq '.message')
done
